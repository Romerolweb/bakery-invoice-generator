# Pre-commit hooks configuration for Bakery Invoice Generator
# See https://pre-commit.com for more information
# See https://pre-commit.com/hooks.html for more hooks

default_language_version:
  node: system
  go: system

repos:
  # ============================================================================
  # ðŸ”’ Security - Detect secrets and credentials
  # ============================================================================
  - repo: https://github.com/gitleaks/gitleaks
    rev: v8.22.1
    hooks:
      - id: gitleaks
        name: "ðŸ”’ security Â· Detect hardcoded secrets"

  # ============================================================================
  # ðŸ“ Filesystem & Git Quality - Basic file hygiene
  # ============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      # File system checks
      - id: check-case-conflict
        name: "ðŸ“ filesystem Â· Check case sensitivity conflicts"
      - id: check-symlinks
        name: "ðŸ“ filesystem Â· Check for broken symlinks"
      - id: check-executables-have-shebangs
        name: "ðŸ“ filesystem Â· Verify executable files have shebangs"
      - id: check-shebang-scripts-are-executable
        name: "ðŸ“ filesystem Â· Verify shebang scripts are executable"

      # Git quality checks
      - id: check-merge-conflict
        name: "ðŸŒ³ git Â· Detect unresolved merge conflicts"
      - id: check-added-large-files
        name: "ðŸŒ³ git Â· Prevent large file commits"
        args: ['--maxkb=10000']  # 10MB limit
      - id: no-commit-to-branch
        name: "ðŸŒ³ git Â· Protect main branches"
        args: ['--branch', 'main', '--branch', 'master']

      # File content checks
      - id: end-of-file-fixer
        name: "âœ¨ files Â· Fix end of file whitespace"
      - id: trailing-whitespace
        name: "âœ¨ files Â· Trim trailing whitespace"
        args: [--markdown-linebreak-ext=md]
      - id: mixed-line-ending
        name: "âœ¨ files Â· Fix mixed line endings"
        args: ['--fix=lf']

  # ============================================================================
  # ðŸ¹ Go - Linting, formatting, and type checking
  # ============================================================================
  - repo: https://github.com/dnephin/pre-commit-golang
    rev: v0.5.1
    hooks:
      - id: go-fmt
        name: "ðŸ¹ go Â· Format code with gofmt"
        args: [-w]
      - id: go-imports
        name: "ðŸ¹ go Â· Organize imports with goimports"
        args: [-w]
      - id: go-vet-mod
        name: "ðŸ¹ go Â· Vet code for issues"
      - id: go-mod-tidy
        name: "ðŸ¹ go Â· Tidy go.mod"
      - id: golangci-lint-mod
        name: "ðŸ¹ go Â· Lint with golangci-lint"
        args: [--fix]

  # ============================================================================
  # ðŸŸ¨ JavaScript/TypeScript - Code quality with ESLint and Prettier
  # ============================================================================
  - repo: https://github.com/pre-commit/mirrors-eslint
    rev: v9.17.0
    hooks:
      - id: eslint
        name: "ðŸŸ¨ typescript Â· Lint with ESLint"
        files: \.(js|jsx|ts|tsx|mjs|cjs)$
        types: [file]
        args:
          - '--fix'
          - '--max-warnings=0'  # Treat warnings as errors
        additional_dependencies:
          - eslint@8.47.0
          - eslint-config-next@13.4.19
          - '@typescript-eslint/eslint-plugin@6.7.4'
          - '@typescript-eslint/parser@6.7.4'

  - repo: https://github.com/pre-commit/mirrors-prettier
    rev: v4.0.0-alpha.8
    hooks:
      - id: prettier
        name: "ðŸŸ¨ typescript Â· Format with Prettier"
        files: \.(js|jsx|ts|tsx|json|css|scss|md|yaml|yml)$
        additional_dependencies:
          - prettier@3.4.2

  # ============================================================================
  # ðŸ” TypeScript - Type checking
  # ============================================================================
  - repo: local
    hooks:
      - id: typescript-check
        name: "ðŸ” typescript Â· Type check"
        entry: npm run typecheck
        language: system
        files: \.(ts|tsx)$
        pass_filenames: false
        require_serial: true

  # ============================================================================
  # âœ… JSON/YAML/TOML Validation
  # ============================================================================
  - repo: https://github.com/pre-commit/pre-commit-hooks
    rev: v5.0.0
    hooks:
      - id: check-json
        name: "âœ… data Â· Validate JSON syntax"
      - id: check-yaml
        name: "âœ… data Â· Validate YAML syntax"
        args: ['--unsafe']  # Allow custom YAML tags
      - id: check-toml
        name: "âœ… data Â· Validate TOML syntax"

  # ============================================================================
  # ðŸ“ Markdown - Format and lint
  # ============================================================================
  - repo: https://github.com/igorshubovych/markdownlint-cli
    rev: v0.43.0
    hooks:
      - id: markdownlint
        name: "ðŸ“ markdown Â· Lint markdown files"
        args: ['--fix']

  # ============================================================================
  # ðŸ³ Docker - Lint Dockerfiles
  # ============================================================================
  - repo: https://github.com/hadolint/hadolint
    rev: v2.12.0
    hooks:
      - id: hadolint-docker
        name: "ðŸ³ docker Â· Lint Dockerfiles"

  # ============================================================================
  # ðŸ“¦ Package.json - Sort and validate
  # ============================================================================
  - repo: local
    hooks:
      - id: package-json-sort
        name: "ðŸ“¦ package Â· Sort package.json"
        entry: npx sort-package-json
        language: system
        files: ^package\.json$

  # ============================================================================
  # ðŸ”§ Custom Local Hooks - Project specific checks
  # ============================================================================
  - repo: local
    hooks:
      # Go specific checks
      - id: go-test
        name: "ðŸ§ª go Â· Run tests"
        entry: bash -c 'cd backend && go test ./...'
        language: system
        files: \.go$
        pass_filenames: false

      - id: go-build-check
        name: "ðŸ”¨ go Â· Build check"
        entry: bash -c 'cd backend && go build ./...'
        language: system
        files: \.go$
        pass_filenames: false

      # Next.js specific checks
      - id: nextjs-build-check
        name: "âš¡ nextjs Â· Build check"
        entry: npm run build
        language: system
        files: \.(ts|tsx|js|jsx|json)$
        pass_filenames: false
        require_serial: true

      # Database migration checks
      - id: migration-validation
        name: "ðŸ—„ï¸ database Â· Validate migrations"
        entry: bash -c 'cd backend && if [ -d "migrations" ]; then echo "Validating migrations..."; for file in migrations/*.sql; do if [ -f "$file" ]; then echo "Checking $file"; fi; done; fi'
        language: system
        files: ^backend/migrations/.*\.sql$
        pass_filenames: false

      # Environment file checks
      - id: env-file-check
        name: "ðŸ” env Â· Check environment files"
        entry: bash -c 'for file in .env.example .env.*.example; do if [ -f "$file" ]; then echo "Checking $file for required variables..."; grep -q "ENVIRONMENT=" "$file" || echo "Warning: $file missing ENVIRONMENT variable"; fi; done'
        language: system
        files: ^\.env.*$
        pass_filenames: false

      # Serverless configuration validation
      - id: serverless-config-check
        name: "â˜ï¸ serverless Â· Validate configurations"
        entry: bash -c 'cd backend/deployments/lambda && for file in serverless*.yml; do if [ -f "$file" ]; then echo "Validating $file..."; npx serverless print --config "$file" > /dev/null || echo "Error in $file"; fi; done'
        language: system
        files: ^backend/deployments/lambda/serverless.*\.yml$
        pass_filenames: false

# ============================================================================
# Configuration
# ============================================================================
fail_fast: false  # Run all hooks even if one fails
minimum_pre_commit_version: '3.0.0'

# Exclude patterns
exclude: |
  (?x)^(
    .*\.min\.(js|css)$|
    node_modules/.*|
    \.next/.*|
    dist/.*|
    build/.*|
    coverage/.*|
    \.git/.*|
    backend/bin/.*|
    backend/data/.*|
    .*\.log$
  )$