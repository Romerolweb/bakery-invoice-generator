service: bakery-invoice-api

provider:
  name: aws
  runtime: provided.al2
  region: ${opt:region, 'us-east-1'}
  stage: ${opt:stage, 'dev'}
  memorySize: 512
  timeout: 30
  environment:
    ENVIRONMENT: ${self:provider.stage}
    DB_CONNECTION_STRING: ${env:DB_CONNECTION_STRING}
    STORAGE_TYPE: s3
    S3_BUCKET: ${env:S3_BUCKET}
    S3_REGION: ${self:provider.region}
    SMTP_HOST: ${env:SMTP_HOST}
    SMTP_PORT: ${env:SMTP_PORT, '587'}
    SMTP_USERNAME: ${env:SMTP_USERNAME}
    SMTP_PASSWORD: ${env:SMTP_PASSWORD}
    SMTP_FROM: ${env:SMTP_FROM}
    JWT_SECRET: ${env:JWT_SECRET}
  
  iamRoleStatements:
    - Effect: Allow
      Action:
        - s3:GetObject
        - s3:PutObject
        - s3:DeleteObject
        - s3:ListBucket
      Resource:
        - "arn:aws:s3:::${env:S3_BUCKET}"
        - "arn:aws:s3:::${env:S3_BUCKET}/*"
    - Effect: Allow
      Action:
        - rds:DescribeDBInstances
        - rds:Connect
      Resource: "*"

functions:
  customers:
    handler: bootstrap
    package:
      artifact: ../../bin/customers.zip
    events:
      - http:
          path: /api/v1/customers
          method: any
          cors: true
      - http:
          path: /api/v1/customers/{proxy+}
          method: any
          cors: true

  products:
    handler: bootstrap
    package:
      artifact: ../../bin/products.zip
    events:
      - http:
          path: /api/v1/products
          method: any
          cors: true
      - http:
          path: /api/v1/products/{proxy+}
          method: any
          cors: true

  receipts:
    handler: bootstrap
    package:
      artifact: ../../bin/receipts.zip
    events:
      - http:
          path: /api/v1/receipts
          method: any
          cors: true
      - http:
          path: /api/v1/receipts/{proxy+}
          method: any
          cors: true

  email:
    handler: bootstrap
    package:
      artifact: ../../bin/email.zip
    events:
      - http:
          path: /api/v1/email/{proxy+}
          method: any
          cors: true

resources:
  Resources:
    # S3 Bucket for file storage
    FileStorageBucket:
      Type: AWS::S3::Bucket
      Properties:
        BucketName: ${env:S3_BUCKET}
        PublicAccessBlockConfiguration:
          BlockPublicAcls: true
          BlockPublicPolicy: true
          IgnorePublicAcls: true
          RestrictPublicBuckets: true
        BucketEncryption:
          ServerSideEncryptionConfiguration:
            - ServerSideEncryptionByDefault:
                SSEAlgorithm: AES256
        VersioningConfiguration:
          Status: Enabled
        LifecycleConfiguration:
          Rules:
            - Id: DeleteIncompleteMultipartUploads
              Status: Enabled
              AbortIncompleteMultipartUpload:
                DaysAfterInitiation: 7

    # RDS Instance (optional - for production)
    DatabaseInstance:
      Type: AWS::RDS::DBInstance
      Properties:
        DBInstanceIdentifier: bakery-invoice-${self:provider.stage}
        DBInstanceClass: db.t3.micro
        Engine: postgres
        EngineVersion: '13.7'
        MasterUsername: ${env:DB_USER}
        MasterUserPassword: ${env:DB_PASSWORD}
        AllocatedStorage: 20
        StorageType: gp2
        StorageEncrypted: true
        VpcSecurityGroups:
          - !Ref DatabaseSecurityGroup
        DBSubnetGroupName: !Ref DatabaseSubnetGroup
        BackupRetentionPeriod: 7
        MultiAZ: false
        PubliclyAccessible: false
        DeletionProtection: true

    # VPC Configuration for RDS
    VPC:
      Type: AWS::EC2::VPC
      Properties:
        CidrBlock: 10.0.0.0/16
        EnableDnsHostnames: true
        EnableDnsSupport: true

    DatabaseSubnetGroup:
      Type: AWS::RDS::DBSubnetGroup
      Properties:
        DBSubnetGroupDescription: Subnet group for RDS database
        SubnetIds:
          - !Ref PrivateSubnet1
          - !Ref PrivateSubnet2

    PrivateSubnet1:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        CidrBlock: 10.0.1.0/24
        AvailabilityZone: ${self:provider.region}a

    PrivateSubnet2:
      Type: AWS::EC2::Subnet
      Properties:
        VpcId: !Ref VPC
        CidrBlock: 10.0.2.0/24
        AvailabilityZone: ${self:provider.region}b

    DatabaseSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Security group for RDS database
        VpcId: !Ref VPC
        SecurityGroupIngress:
          - IpProtocol: tcp
            FromPort: 5432
            ToPort: 5432
            SourceSecurityGroupId: !Ref LambdaSecurityGroup

    LambdaSecurityGroup:
      Type: AWS::EC2::SecurityGroup
      Properties:
        GroupDescription: Security group for Lambda functions
        VpcId: !Ref VPC

  Outputs:
    ApiGatewayRestApiId:
      Value:
        Ref: ApiGatewayRestApi
      Export:
        Name: ${self:service}-${self:provider.stage}-restApiId

    ApiGatewayRestApiRootResourceId:
      Value:
        Fn::GetAtt:
          - ApiGatewayRestApi
          - RootResourceId
      Export:
        Name: ${self:service}-${self:provider.stage}-rootResourceId

    S3BucketName:
      Value: ${env:S3_BUCKET}
      Export:
        Name: ${self:service}-${self:provider.stage}-s3Bucket

plugins:
  - serverless-offline

custom:
  serverless-offline:
    httpPort: 3001
    lambdaPort: 3002