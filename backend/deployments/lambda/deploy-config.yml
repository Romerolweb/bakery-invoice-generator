# Deployment Configuration for Bakery Invoice API Lambda Functions
# This file contains environment-specific deployment configurations

environments:
  dev:
    region: us-east-1
    stage: dev
    memory: 256
    timeout: 15
    environment_variables:
      LOG_LEVEL: debug
      DB_CONNECTION_STRING: /mnt/efs/bakery-dev.db
      S3_BUCKET: bakery-invoice-dev-files
      SMTP_HOST: localhost
      SMTP_PORT: 1025
    vpc_config:
      enabled: false  # No VPC for dev to save costs
    monitoring:
      enabled: true
      log_retention: 7  # days
    warmup:
      enabled: true
      schedule: rate(5 minutes)
    
  staging:
    region: us-east-1
    stage: staging
    memory: 512
    timeout: 25
    environment_variables:
      LOG_LEVEL: info
      DB_CONNECTION_STRING: ${env:DB_CONNECTION_STRING}
      S3_BUCKET: bakery-invoice-staging-files
    vpc_config:
      enabled: true
      security_groups:
        - staging-lambda-sg
      subnets:
        - staging-private-subnet-1
        - staging-private-subnet-2
    monitoring:
      enabled: true
      log_retention: 14  # days
      alarms:
        - errors
        - duration
        - throttles
    warmup:
      enabled: true
      schedule: rate(10 minutes)
    
  prod:
    region: us-east-1
    stage: prod
    memory: 1024
    timeout: 30
    environment_variables:
      LOG_LEVEL: warn
      DB_CONNECTION_STRING: ${env:DB_CONNECTION_STRING}
      S3_BUCKET: ${env:S3_BUCKET}
    vpc_config:
      enabled: true
      security_groups:
        - prod-lambda-sg
      subnets:
        - prod-private-subnet-1
        - prod-private-subnet-2
    monitoring:
      enabled: true
      log_retention: 30  # days
      alarms:
        - errors
        - duration
        - throttles
        - invocations
      enhanced_monitoring: true
      x_ray_tracing: true
    warmup:
      enabled: true
      schedule: rate(15 minutes)
    provisioned_concurrency:
      customers: 5
      products: 5
      receipts: 10
      email: 2
    reserved_concurrency:
      customers: 50
      products: 50
      receipts: 100
      email: 25

# Function-specific configurations
functions:
  customers:
    description: "Handles customer-related operations"
    handler: bootstrap
    events:
      - http:
          path: /api/v1/customers
          method: any
          cors: true
      - http:
          path: /api/v1/customers/{proxy+}
          method: any
          cors: true
    
  products:
    description: "Handles product-related operations"
    handler: bootstrap
    events:
      - http:
          path: /api/v1/products
          method: any
          cors: true
      - http:
          path: /api/v1/products/{proxy+}
          method: any
          cors: true
    
  receipts:
    description: "Handles receipt-related operations"
    handler: bootstrap
    events:
      - http:
          path: /api/v1/receipts
          method: any
          cors: true
      - http:
          path: /api/v1/receipts/{proxy+}
          method: any
          cors: true
    
  email:
    description: "Handles email-related operations"
    handler: bootstrap
    events:
      - http:
          path: /api/v1/email/{proxy+}
          method: any
          cors: true

# Deployment settings
deployment:
  package:
    individually: true
    exclude:
      - ./**
    include:
      - bin/*.zip
  
  # Build settings
  build:
    go_version: "1.24.6"
    build_flags: "-ldflags='-s -w'"
    cgo_enabled: false
    goos: linux
    goarch: amd64
  
  # Validation settings
  validation:
    pre_deploy:
      - build_check
      - test_check
      - security_scan
    post_deploy:
      - health_check
      - integration_test
      - performance_test

# Monitoring and alerting
monitoring:
  cloudwatch:
    log_groups:
      retention_days: 14
    metrics:
      - function_errors
      - function_duration
      - function_throttles
      - function_invocations
      - function_concurrent_executions
  
  alarms:
    error_rate:
      threshold: 1  # percent
      period: 300   # seconds
      evaluation_periods: 2
    
    duration:
      threshold: 10000  # milliseconds
      period: 300
      evaluation_periods: 2
    
    throttles:
      threshold: 1
      period: 300
      evaluation_periods: 1

# Security settings
security:
  iam:
    role_name: bakery-invoice-lambda-role
    policies:
      - s3_access
      - rds_access
      - logs_access
      - xray_access
  
  encryption:
    environment_variables: true
    s3_buckets: true
    rds_instances: true
  
  vpc:
    enable_nat_gateway: true
    enable_dns_hostnames: true
    enable_dns_support: true

# Cost optimization
cost_optimization:
  reserved_concurrency:
    enabled: true
    max_concurrent_executions: 1000
  
  provisioned_concurrency:
    enabled_environments:
      - prod
    schedule:
      scale_up: "0 8 * * MON-FRI"  # 8 AM weekdays
      scale_down: "0 18 * * MON-FRI"  # 6 PM weekdays
  
  lifecycle:
    log_retention:
      dev: 7
      staging: 14
      prod: 30
    
    s3_transitions:
      standard_ia: 30  # days
      glacier: 90      # days